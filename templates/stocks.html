{% extends "base.html" %}
{% block content %}
<h2>Stock: {{ symbol }}</h2>
<p>Current price: {{ price }}</p>

<!-- Charts Section -->
{% if ml and ml.charts %}
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h4>ðŸ“Š Technical Analysis Charts</h4>
    </div>
    <div class="card-body">
        <div class="row">
            {% if ml.charts.price_rsi %}
            <div class="col-md-6 mb-4">
                <h5>Price & RSI Analysis</h5>
                <img src="{{ ml.charts.price_rsi }}" alt="Price and RSI Chart" class="img-fluid" style="border: 1px solid #ddd; border-radius: 5px;">
                <p class="text-muted mt-2"><small>Upper chart shows price movement with moving averages. Lower chart shows RSI indicator with overbought/oversold levels.</small></p>
            </div>
            {% endif %}

            {% if ml.charts.volume %}
            <div class="col-md-6 mb-4">
                <h5>Volume Analysis</h5>
                <img src="{{ ml.charts.volume }}" alt="Volume Chart" class="img-fluid" style="border: 1px solid #ddd; border-radius: 5px;">
                <p class="text-muted mt-2"><small>Shows trading volume with 20-day moving average. High volume often confirms price trends.</small></p>
            </div>
            {% endif %}

            {% if ml.charts.macd %}
            <div class="col-md-6 mb-4">
                <h5>MACD Indicator</h5>
                <img src="{{ ml.charts.macd }}" alt="MACD Chart" class="img-fluid" style="border: 1px solid #ddd; border-radius: 5px;">
                <p class="text-muted mt-2"><small>MACD shows momentum and trend changes. Crossings above/below zero line indicate buy/sell signals.</small></p>
            </div>
            {% endif %}

            {% if ml.charts.bollinger %}
            <div class="col-md-6 mb-4">
                <h5>Bollinger Bands</h5>
                <img src="{{ ml.charts.bollinger }}" alt="Bollinger Bands Chart" class="img-fluid" style="border: 1px solid #ddd; border-radius: 5px;">
                <p class="text-muted mt-2"><small>Bollinger Bands show volatility and potential support/resistance levels. Price touching bands may indicate reversals.</small></p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<h3>ML Analysis</h3>
{% if ml %}
  {% if ml.error %}
    <p>{{ ml.error }}</p>
  {% else %}
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5>Price Analysis</h5>
                    <ul class="list-unstyled">
                        <li><strong>Latest Price:</strong> â‚¹{{ "%.2f"|format(ml.latest_price) }}</li>
                        <li><strong>Trend:</strong>
                            <span class="badge {% if 'Up' in ml.trend %}bg-success{% else %}bg-danger{% endif %}">
                                {{ ml.trend }}
                            </span>
                        </li>
                        <li><strong>Slope:</strong> {{ ml.slope | round(4) }}</li>
                        <li><strong>Volatility (annual):</strong> {{ ml.volatility_annual | round(4) }}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h5>Technical Indicators</h5>
                    <ul class="list-unstyled">
                        <li><strong>MA20:</strong> {{ ml.ma20 | round(2) if ml.ma20 else 'N/A' }}</li>
                        <li><strong>MA50:</strong> {{ ml.ma50 | round(2) if ml.ma50 else 'N/A' }}</li>
                        <li><strong>RSI:</strong>
                            {% if ml.rsi %}
                                <span class="{% if ml.rsi < 30 %}text-success{% elif ml.rsi > 70 %}text-danger{% endif %}">
                                    {{ ml.rsi | round(2) }}
                                </span>
                            {% else %}
                                N/A
                            {% endif %}
                        </li>
                        <li><strong>Signal:</strong>
                            <span class="badge {% if ml.signal == 'BUY' %}bg-success{% elif ml.signal == 'SELL' %}bg-danger{% else %}bg-warning{% endif %}">
                                {{ ml.signal }} ({{ ml.confidence }})
                            </span>
                        </li>
                    </ul>
                </div>
            </div>

            {% if ml.prediction and ml.prediction.predicted_price %}
            <div class="alert alert-info mt-3">
                <h6>ðŸ“ˆ Price Prediction</h6>
                <strong>Next Day:</strong> â‚¹{{ "%.2f"|format(ml.prediction.predicted_price) }}
                ({{ "%+.2f"|format(ml.prediction.predicted_change_percent) }}%)
                <br><small>Method: {{ ml.prediction.method }} | Based on {{ ml.data_points }} data points</small>
            </div>
            {% endif %}
        </div>
    </div>
  {% endif %}
{% endif %}

{% if gemini %}
  <h3>Gemini Analysis (if enabled)</h3>
  {% if gemini is string %}
    {# Handle string errors #}
    <p>{{ gemini }}</p>
  {% elif gemini.error %}
    {# Handle error objects #}
    <p style="color: red;">Error: {{ gemini.error }}</p>
  {% elif gemini.analysis %}
    {# New format from interactive_gemini_analysis #}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h4>ðŸ§  AI Analysis (Gemini)</h4>
        </div>
        <div class="card-body">
            <div class="gemini-analysis">
                {{ gemini.analysis }}
            </div>
            {% if gemini.ml_context %}
            <hr>
            <h5>Technical Context</h5>
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li><strong>Latest Price:</strong> â‚¹{{ gemini.ml_context.latest_price }}</li>
                        <li><strong>Trend:</strong> {{ gemini.ml_context.trend }}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li><strong>Signal:</strong> {{ gemini.ml_context.signal }}</li>
                        <li><strong>Analysis Date:</strong> {{ gemini.timestamp }}</li>
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
  {% elif gemini.gemini_text %}
    {# Old format from analyze_with_gemini #}
    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #17a2b8;">
      {{ gemini.gemini_text }}
    </div>
    {% if gemini.ml_summary %}
    <div style="margin-top: 15px;">
      <h4>ML Summary:</h4>
      <ul>
        <li><strong>Latest Price:</strong> {{ gemini.ml_summary.latest_price }}</li>
        <li><strong>Trend:</strong> {{ gemini.ml_summary.trend }}</li>
        <li><strong>Signal:</strong> {{ gemini.ml_summary.signal }}</li>
      </ul>
    </div>
    {% endif %}
  {% else %}
    {# Fallback for any list format #}
    <ul>
      {% for item in gemini %}
        <li><strong>{{ item.key }}:</strong> {{ item.value }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endif %}

<form method="get" action="/stocks">
  <label>Search symbol: <input name="q" value="{{ symbol }}" /></label>
  <button type="submit">Search</button>
</form>

<h3>Finance News</h3>
{% if news %}
  <div class="news-cards">
    {% for article in news %}
      <div class="news-card">
        <a href="{{ article.url }}" target="_blank">
          <img src="{{ article.urlToImage }}" alt="News image" style="width: 100%; height: 150px; object-fit: cover;"/>
          <div class="news-content">
            <h4>{{ article.title }}</h4>
            <p>{{ article.description or '' }}</p>
            <small>Source: {{ article.source.name }} | {{ article.publishedAt[:10] }}</small>
          </div>
        </a>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>No news available at the moment.</p>
{% endif %}

<style>
.news-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}
.news-card {
  border: 1px solid #ddd;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}
.news-card:hover {
  transform: translateY(-2px);
}
.news-content {
  padding: 15px;
}
.news-content h4 {
  margin: 0 0 10px 0;
  font-size: 1.1em;
}
.news-content p {
  color: #666;
  margin: 0 0 10px 0;
}
.news-content small {
  color: #888;
}
.gemini-analysis {
    line-height: 1.6;
    font-size: 1.05em;
    white-space: pre-wrap;
}
.badge {
    font-size: 0.8em;
    padding: 4px 8px;
}
.card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: none;
    border-radius: 10px;
}
.card-header {
    border-radius: 10px 10px 0 0 !important;
    font-weight: 600;
}
.alert {
    border: none;
    border-radius: 8px;
}
</style>
{% endblock %}