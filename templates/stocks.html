{% extends "base.html" %}
{% block content %}
<h2>Stock: {{ symbol }}</h2>
<p>Current price: {{ price }}</p>

<h3>ML Analysis</h3>
{% if ml %}
  {% if ml.error %}
    <p>{{ ml.error }}</p>
  {% else %}
    <ul>
      <li>Latest price: {{ ml.latest_price }}</li>
      <li>Trend: {{ ml.trend }}</li>
      <li>Volatility (annual): {{ ml.volatility_annual }}</li>
      <li>MA20: {{ ml.ma20 }}</li>
      <li>MA50: {{ ml.ma50 }}</li>
      <li>Signal: {{ ml.signal }}</li>
      <li>Data points: {{ ml.data_points }}</li>
    </ul>
  {% endif %}
{% endif %}

{% if gemini %}
  <h3>Gemini Analysis (if enabled)</h3>
  {% if gemini is string %}
    {# Handle string errors #}
    <p>{{ gemini }}</p>
  {% elif gemini.error %}
    {# Handle error objects #}
    <p style="color: red;">Error: {{ gemini.error }}</p>
  {% elif gemini.analysis %}
    {# New format from interactive_gemini_analysis #}
    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #17a2b8;">
      {{ gemini.analysis }}
    </div>
    {% if gemini.ml_context %}
    <div style="margin-top: 15px;">
      <h4>Technical Context:</h4>
      <ul>
        <li><strong>Latest Price:</strong> {{ gemini.ml_context.latest_price }}</li>
        <li><strong>Trend:</strong> {{ gemini.ml_context.trend }}</li>
        <li><strong>Signal:</strong> {{ gemini.ml_context.signal }}</li>
        <li><strong>Volatility:</strong> {{ gemini.ml_context.volatility_annual }}</li>
      </ul>
    </div>
    {% endif %}
  {% elif gemini.gemini_text %}
    {# Old format from analyze_with_gemini #}
    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #17a2b8;">
      {{ gemini.gemini_text }}
    </div>
    {% if gemini.ml_summary %}
    <div style="margin-top: 15px;">
      <h4>ML Summary:</h4>
      <ul>
        <li><strong>Latest Price:</strong> {{ gemini.ml_summary.latest_price }}</li>
        <li><strong>Trend:</strong> {{ gemini.ml_summary.trend }}</li>
        <li><strong>Signal:</strong> {{ gemini.ml_summary.signal }}</li>
      </ul>
    </div>
    {% endif %}
  {% else %}
    {# Fallback for any list format #}
    <ul>
      {% for item in gemini %}
        <li><strong>{{ item.key }}:</strong> {{ item.value }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endif %}

<form method="get" action="/stocks">
  <label>Search symbol: <input name="q" value="{{ symbol }}" /></label>
  <button type="submit">Search</button>
</form>

<h3>Finance News</h3>
{% if news %}
  <div class="news-cards">
    {% for article in news %}
      <div class="news-card">
        <a href="{{ article.url }}" target="_blank">
          <img src="{{ article.urlToImage }}" alt="News image" style="width: 100%; height: 150px; object-fit: cover;"/>
          <div class="news-content">
            <h4>{{ article.title }}</h4>
            <p>{{ article.description or '' }}</p>
            <small>Source: {{ article.source.name }} | {{ article.publishedAt[:10] }}</small>
          </div>
        </a>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>No news available at the moment.</p>
{% endif %}

<style>
.news-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}
.news-card {
  border: 1px solid #ddd;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}
.news-card:hover {
  transform: translateY(-2px);
}
.news-content {
  padding: 15px;
}
.news-content h4 {
  margin: 0 0 10px 0;
  font-size: 1.1em;
}
.news-content p {
  color: #666;
  margin: 0 0 10px 0;
}
.news-content small {
  color: #888;
}
</style>
{% endblock %}