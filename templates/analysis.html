{% extends "base.html" %}
{% block content %}
<h2>Stock Analysis</h2>

<!-- Symbol Input Form -->
<form method="post" class="mb-4">
  <label>Symbol: <input name="symbol" value="{{ symbol or '' }}" /></label>
  <button type="submit">Analyze</button>
</form>

{% if result %}
  <h3>Results for {{ symbol }}</h3>

  <!-- ML Summary -->
  {% if result.ml %}
    <div class="card mb-3" style="padding: 15px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9;">
      <h4>ML Summary</h4>
      {% if result.ml.error %}
        <p style="color:red;">{{ result.ml.error }}</p>
      {% else %}
        <ul>
          <li><strong>Latest Price:</strong> ${{ result.ml.latest_price }}</li>
          <li><strong>Trend:</strong> {{ result.ml.trend }}</li>
          <li><strong>Slope:</strong> {{ result.ml.slope | round(4) }}</li>
          <li><strong>Volatility (annual):</strong> {{ result.ml.volatility_annual | round(4) }}</li>
          <li><strong>MA20:</strong> {{ result.ml.ma20 | round(2) if result.ml.ma20 else 'N/A' }}</li>
          <li><strong>MA50:</strong> {{ result.ml.ma50 | round(2) if result.ml.ma50 else 'N/A' }}</li>
          <li><strong>Signal:</strong> {{ result.ml.signal }}</li>
          <li><strong>Data Points:</strong> {{ result.ml.data_points }}</li>
        </ul>
      {% endif %}
    </div>
  {% endif %}

  <!-- Gemini Analysis -->
  {% if result.gemini %}
    <div class="card mb-3" style="padding: 15px; border: 1px solid #4CAF50; border-radius: 8px; background: #e8f5e9;">
      <h4>Gemini Analysis</h4>
      {% if result.gemini.error %}
        <p style="color:red;">{{ result.gemini.error }}</p>
      {% else %}
        {# Handle both old and new Gemini response formats #}
        {% if result.gemini.analysis %}
          {# New format from interactive_gemini_analysis #}
          <p>{{ result.gemini.analysis }}</p>
          <hr>
          <h5>Technical Context</h5>
          <ul>
            <li><strong>Latest Price:</strong> ${{ result.gemini.ml_context.latest_price }}</li>
            <li><strong>Trend:</strong> {{ result.gemini.ml_context.trend }}</li>
            <li><strong>Signal:</strong> {{ result.gemini.ml_context.signal }}</li>
          </ul>
        {% elif result.gemini.gemini_text %}
          {# Old format from analyze_with_gemini #}
          <p>{{ result.gemini.gemini_text }}</p>
          <hr>
          <h5>ML Summary</h5>
          <ul>
            <li><strong>Latest Price:</strong> ${{ result.gemini.ml_summary.latest_price }}</li>
            <li><strong>Trend:</strong> {{ result.gemini.ml_summary.trend }}</li>
            <li><strong>Signal:</strong> {{ result.gemini.ml_summary.signal }}</li>
          </ul>
        {% else %}
          {# Fallback for any other format #}
          <p>{{ result.gemini }}</p>
        {% endif %}
      {% endif %}
    </div>

    <!-- Interactive Q&A Form -->
    <div class="card mb-3" style="padding: 15px; border: 1px solid #2196F3; border-radius: 8px; background: #e3f2fd;">
      <h4>Ask Gemini a Question</h4>
      <form id="ask-gemini-form">
        <input type="hidden" name="symbol" value="{{ symbol }}">
        <textarea name="question" rows="3" style="width: 100%;" placeholder="Ask anything about {{ symbol }}"></textarea>
        <button type="submit" class="mt-2">Ask Gemini</button>
      </form>

      {% if gemini_reply %}
        <hr>
        <strong>Gemini says:</strong>
        <p>{{ gemini_reply.analysis if gemini_reply.analysis else gemini_reply }}</p>
      {% endif %}

      <div id="gemini-response" class="mt-3" style="display: none;">
        <hr>
        <strong>Gemini says:</strong>
        <div id="response-content"></div>
      </div>
    </div>
  {% endif %}
{% endif %}

<script>
// Interactive Gemini question handler
document.getElementById('ask-gemini-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const question = formData.get('question');
    const symbol = formData.get('symbol');

    if (!question.trim()) {
        alert('Please enter a question');
        return;
    }

    const responseDiv = document.getElementById('gemini-response');
    const contentDiv = document.getElementById('response-content');

    // Show loading
    contentDiv.innerHTML = 'üîÑ Thinking...';
    responseDiv.style.display = 'block';

    try {
        const response = await fetch('/api/ask-gemini', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                symbol: symbol,
                question: question
            })
        });

        const data = await response.json();

        if (data.error) {
            contentDiv.innerHTML = `‚ùå Error: ${data.error}`;
        } else {
            contentDiv.innerHTML = data.analysis.replace(/\n/g, '<br>');
        }
    } catch (error) {
        contentDiv.innerHTML = `‚ùå Network error: ${error.message}`;
    }
});
</script>

<style>
.card {
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>
{% endblock %}